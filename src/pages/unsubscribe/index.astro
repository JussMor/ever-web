---
import Layout from '../../layouts/Layout.astro';

const url = Astro.url;
const email = url.searchParams.get('email') || '';
const success = url.searchParams.get('success') === 'true';
---

<Layout title="Unsubscribe - Everfaz">
  <main class="min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
    <div class="sm:mx-auto sm:w-full sm:max-w-md">
      <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          {success ? 'Unsubscribed Successfully' : 'Unsubscribe from Emails'}
        </h1>
        
        {success ? (
          <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-8">
            <div class="flex items-center">
              <svg class="h-8 w-8 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              <div class="text-left">
                <h3 class="text-lg font-medium text-green-900 mb-1">
                  You've been unsubscribed
                </h3>
                <p class="text-green-700 text-sm">
                  {email && `The email address ${email} has been`} removed from all our mailing lists.
                </p>
              </div>
            </div>
          </div>
        ) : (
          <p class="text-gray-600 mb-8">
            We're sorry to see you go. Enter your email address below to unsubscribe from all future emails.
          </p>
        )}
      </div>
    </div>

    {!success && (
      <div class="sm:mx-auto sm:w-full sm:max-w-md">
        <div class="bg-white py-8 px-6 shadow-lg rounded-lg sm:px-10">
          <form id="unsubscribe-form" method="POST" action="/api/unsubscribe">
            <div class="mb-6">
              <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                Email address
              </label>
              <input
                type="email"
                name="email"
                id="email"
                required
                value={email}
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Enter your email address"
              />
            </div>

            <div class="mb-6">
              <button
                type="submit"
                class="w-full bg-red-600 text-white py-2 px-4 rounded-md font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors duration-200"
              >
                Unsubscribe
              </button>
            </div>

            <div class="text-xs text-gray-500 text-center">
              <p class="mb-2">
                By clicking "Unsubscribe", you will no longer receive marketing emails from Everfaz.
                You may still receive important transactional emails related to your account or services.
              </p>
            </div>
          </form>

          <div id="message" class="hidden mt-4 p-4 rounded-md"></div>
        </div>
      </div>
    )}

    <div class="sm:mx-auto sm:w-full sm:max-w-md mt-8 text-center">
      <p class="text-sm text-gray-500 mb-4">
        Change your mind? You can always 
        <a href="/contact" class="text-blue-600 hover:text-blue-500 font-medium">contact us</a>
        to resubscribe.
      </p>
      
      <div class="bg-gray-100 rounded-lg p-6 text-left">
        <h3 class="font-semibold text-gray-900 mb-3">Our Email Commitment:</h3>
        <ul class="text-sm text-gray-600 space-y-2">
          <li class="flex items-start">
            <span class="text-green-500 mr-2">✓</span>
            We only send emails to people who have explicitly opted in
          </li>
          <li class="flex items-start">
            <span class="text-green-500 mr-2">✓</span>
            We comply with the AWS Acceptable Use Policy
          </li>
          <li class="flex items-start">
            <span class="text-green-500 mr-2">✓</span>
            We maintain proper bounce and complaint handling
          </li>
          <li class="flex items-start">
            <span class="text-green-500 mr-2">✓</span>
            We respect your privacy and email preferences
          </li>
        </ul>
      </div>
    </div>
  </main>

  <script>
    const unsubForm = document.getElementById('unsubscribe-form');
    if (unsubForm) {
      unsubForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const form = e.target;
        if (!form || !(form instanceof HTMLFormElement)) return;
        
        const formData = new FormData(form);
        const messageDiv = document.getElementById('message');
        if (!messageDiv) return;
        
        try {
          const response = await fetch('/api/unsubscribe', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            messageDiv.className = 'mt-4 p-4 rounded-md bg-green-50 border border-green-200 text-green-800';
            messageDiv.textContent = 'Successfully unsubscribed! You will no longer receive emails from us.';
            messageDiv.classList.remove('hidden');
            
            // Hide the form
            form.style.display = 'none';
          } else {
            messageDiv.className = 'mt-4 p-4 rounded-md bg-red-50 border border-red-200 text-red-800';
            messageDiv.textContent = result.error || 'Failed to unsubscribe. Please try again.';
            messageDiv.classList.remove('hidden');
          }
        } catch (error) {
          messageDiv.className = 'mt-4 p-4 rounded-md bg-red-50 border border-red-200 text-red-800';
          messageDiv.textContent = 'An error occurred. Please try again.';
          messageDiv.classList.remove('hidden');
        }
      });
    }
  </script>
</Layout>
